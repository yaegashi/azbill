# azbill

## Introduction

azbill is a cross-platform CLI tool to bulk export Azure billing data in CSV or JSONL format
which is useful for the off-line cost analysis.

## Usage

```console
$ azbill -h
Azure billing data exporter

Usage:
  azbill [command]

Available Commands:
  accounts      List billing accounts you have access to
  help          Help about any command
  invoices      List invoices
  login         Force auth-dev login
  subscriptions List subscriptions
  tenants       List tenants
  usage-details List usage details

Flags:
      --auth string         auth source [dev,env,file,cli] (env:AZBILL_AUTH, default:dev)
      --auth-dev string     auth dev store (env:AZBILL_AUTH_DEV, default:auth_dev.json)
      --auth-file string    auth file store (env:AZBILL_AUTH_FILE, default:auth_file.json)
      --client string       Azure client (env:AZURE_CLIENT_ID, default:4a034c56-da44-48ce-90db-039a408974bd)
      --config-dir string   config dir (env:AZBILL_CONFIG_DIR, default:~/.azbill)
      --format string       output format [csv,json,flatten,pretty] (env:AZBILL_FORMAT, default:csv)
  -h, --help                help for azbill
  -o, --output string       output file
  -q, --quiet               quiet
      --tenant string       Azure tenant (env:AZURE_TENANT_ID, default:common)
  -v, --version             version for azbill

Use "azbill [command] --help" for more information about a command.
```

### Authentication

You can sign in using [device authorization grant flow](https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-device-code) by `azbill login`:

```console
$ azbill login
2020/07/06 23:05:05 To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code HL94ZL7Y8 to authenticate.
2020/07/06 23:05:21 Saving auth-dev token in /Users/yaegashi/.azbill/auth_dev.json
```

To sign in with other tenant than your home tenant:

```console
$ azbill login --tenant l0wdev.onmicrosoft.com
```

The persistent auth token is saved in `~/.azbill/auth_dev.json` per default.
You can specify a custom location to save it with `--auth-dev`.
It's a relative path in the config dir specifyed by `--config-dir` (default: `~/.azbill`).
You can also pass an Azure Blob Storage URL with SAS, which is especially useful in the CI/CD environment.

[Other authentication methods supported by Azure SDK for Go](https://docs.microsoft.com/en-us/azure/developer/go/azure-sdk-authorization) are also available.  You can select the preferred method by `--auth`.
If you've already signed in with the Azure CLI, `--auth cli` would be most useful.
You can use an auth file generated by the Azure CLI by `--auth file` and `--auth-file` to specify its location.

### Examples

List [billing accounts](https://docs.microsoft.com/en-us/azure/cost-management-billing/manage/view-all-accounts) you have access to in CSV format:

```console
$ azbill accounts
```

List tenants in JSONL format:

```console
$ azbill tenants --format json
```

List subscriptions in flatten JSONL format:

```console
$ azbill subscriptions --format flatten
```

List invoices of the first half of 2020 for subscription XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX in pretty JSON format:

```console
$ azbill invoices --format pretty -S XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX --start 2020-06-01 --end 2020-06-30
```

For Microsoft Online Service Program accounts: List usage details of June 2020 for subscription XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX into usage.jsonl in flatten and pretty JSONL format:

```console
$ azbill usage-details --format flatten,pretty -S XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX --start 2020-06-01 --end 2020-06-30 -o usage.jsonl
2020/07/06 23:43:59 Loading auth-dev token in /Users/yaegashi/.azbill/auth_dev.json
2020/07/06 23:43:59 Requesting with consumption.UsageDetailsClient
2020/07/06 23:43:59    scope: "subscriptions/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"
2020/07/06 23:43:59   filter: "properties/usageStart eq '2020-06-01' and properties/usageEnd eq '2020-06-30'"
2020/07/06 23:44:11 Writing to "usage.jsonl" in json,flatten,pretty
.                                                       138 records
2020/07/06 23:44:11 Done 138 records in 16.893702ms, 8168.724653 records/sec
```

For Enterprise Agreement accounts: Export usage details of billing period 202006 for billing account XXXXXXXX into usage.csv in CSV format:

```console
$ azbill usage-details --format csv -A XXXXXXXX -P 202006 -o usage.csv
2020/07/06 23:45:15 Loading auth-dev token in /Users/yaegashi/.azbill/auth_dev.json
2020/07/06 23:45:15 Requesting with consumption.UsageDetailsClient
2020/07/06 23:45:15    scope: "providers/Microsoft.Billing/billingAccounts/XXXXXXXX/providers/Microsoft.Billing/billingPeriods/202006"
2020/07/06 23:45:15   filter: ""
2020/07/06 23:45:34 Writing to "usage.csv" in csv
..................................................     5000 records
..................................................    10000 records
..................................................    15000 records
....................                                  17001 records
2020/07/06 23:46:38 Done 17001 records in 1m4.325743007s, 264.295431 records/sec
```

## Development

azbill utilizes [Azure REST API](https://docs.microsoft.com/en-us/rest/api/azure/)
and the API version not yet available in [Azure SDK for Go](https://github.com/Azure/azure-sdk-for-go)
to acquire all the usage details including the reservation
in [the consumption API](https://docs.microsoft.com/en-us/rest/api/consumption/).

The shell script [gen.sh](./gen.sh) is used to generate the SDK code in local
[azure-sdk-for-go](azure-sdk-for-go) directory using [the AutoRest CLI](https://github.com/Azure/autorest).
You need to [install AutoRest](https://github.com/Azure/autorest/blob/master/docs/installing-autorest.md)
to run it for yourself.
